<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Probability Distribution Simulator</title>
    <!-- Include MathJax for LaTeX rendering -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>
    <!-- Include Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Include Montserrat font -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <!-- Custom CSS for styling -->
    <style>
        html, body {
            margin: 0;
            padding: 0;
            font-family: 'Montserrat', sans-serif;
            font-style: normal;
            font-weight: 400;
            font-size: 19px;
            line-height: 28px;
            color: #1c1c1c;
            background-color: #ffffff;
        }
        h1 {
            font-size: 36px;
            color: #095f7a;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
        }
        h2 {
            font-size: 24px;
            color: #095f7a;
            font-weight: bold;
            margin-top: 40px;
            text-align: center;
        }
        p {
            margin-bottom: 20px;
            text-align: center;
        }
        strong {
            font-weight: bold;
        }
        .container {
            text-align: center;
            margin: 0 auto;
            max-width: 1200px;
        }
        .step-label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #495057;
        }
        .form-control {
            max-width: 200px;
            margin: 0 auto;
        }
        .btn-custom {
            background-color: #095f7a;
            color: white !important;
            border: none;
            transition: box-shadow 0.3s ease;
            font-family: 'Montserrat', sans-serif;
            font-weight: bold;
            border-radius: 20px;
            font-size: 18px;
            padding: 12px 25px;
            cursor: pointer;
        }
        .btn-custom:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            color: white !important;
        }
        /* Style adjustments for inputs */
        .inputs-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-grow: 1;
            padding: 10px;
        }
        .inputs-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-start;
        }
        .input-item {
            flex: 0 0 auto;
            margin: 10px;
        }
        .inputs-container .form-control {
            max-width: 200px;
            width: 100%;
        }
        /* Adjust probabilities styling */
        .probabilities {
            overflow-x: auto;
            margin: 0 auto;
            max-width: 400px;
        }
        .probabilities .prob-inputs {
            display: inline-block;
            white-space: nowrap;
        }
        .probabilities .form-group {
            display: inline-block;
            vertical-align: middle;
            margin: 5px;
        }
        .probabilities label {
            margin-right: 5px;
        }
        .probabilities input[type="number"] {
            width: 80px;
            display: inline-block;
        }
        #invalidMessage {
            color: red;
            font-weight: bold;
        }
        /* Additional styling for stats section */
        .stats-container {
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-grow: 1;
            height: 100%;
            justify-content: center;
        }
        .stats-header {
            font-weight: bold;
            margin-bottom: 10px;
            color: #495057;
        }
        .stats-value {
            font-size: 1em;
            margin: 5px 0;
        }
        /* New styles for graph and stats layout */
        .graph-and-stats {
            display: flex;
            flex-wrap: wrap;
            align-items: stretch;
            margin-top: 50px;
        }
        .graph-container {
            flex: 0 0 90%;
            max-width: 90%;
            position: relative;
            display: flex;
            flex-direction: column;
            height: auto;
        }
        .stats-table-container {
            flex: 0 0 10%;
            max-width: 10%;
            display: flex;
            align-items: center;
            justify-content: center;
            height: auto;
        }
        @media (max-width: 1000px) {
            .graph-container, .stats-table-container {
                flex: 0 0 100%;
                max-width: 100%;
            }
            .controls {
                flex-wrap: wrap;
            }
            .btn-custom {
                margin-top: 10px;
            }
        }
        .graph-container canvas {
            width: 98% !important;
            height: 400px !important;
            margin: 0 auto;
            display: block;
            margin-bottom: 30px;
        }
        /* Controls styling */
        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: nowrap;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
        }
        .controls label {
            margin: 0 5px 0 0;
        }
        .controls input {
            width: 100px;
            margin-right: 10px;
        }
        .controls button {
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <!-- Research Content -->
        <h2>Fundamental Theorem of Calculus and Its Relationship with Density Functions and CDFs</h2>
        <p>The Fundamental Theorem of Calculus connects differentiation and integration, providing a way to evaluate definite integrals. It states that if \( f \) is continuous on the interval \([a, b]\) and \( F \) is an antiderivative of \( f \) on \([a, b]\), then:</p>
        \[
        \int_a^b f(x) \, dx = F(b) - F(a)
        \]
        <p>In probability theory, the cumulative distribution function (CDF) \( F(x) \) of a continuous random variable is defined as:</p>
        \[
        F(x) = \int_{-\infty}^x f(t) \, dt
        \]
        <p>where \( f(t) \) is the probability density function (PDF). The relationship between the PDF and CDF mirrors the Fundamental Theorem of Calculus, as the derivative of the CDF yields the PDF:</p>
        \[
        f(x) = \frac{d}{dx} F(x)
        \]
        <p>This illustrates how the Fundamental Theorem of Calculus underpins the connection between density functions and cumulative distribution functions in probability theory.</p>
        <h1>Probability Distribution Simulator</h1>
        <!-- Instructions -->
        <p>This simulator generates samples from a discrete univariate probability distribution with arbitrary probabilities. It shows the convergence of the empirical distribution to the theoretical distribution as the sample size increases. It also computes mean and variance using Welford's algorithm and compares them with the theoretical values.</p>
        <!-- Inputs Container -->
        <div class="inputs-container mt-4">
            <div class="inputs-row">
                <!-- Number of Intervals -->
                <div class="input-item text-center">
                    <div class="step-label">1. Enter the Number of Intervals:</div>
                    <input class="form-control d-inline-block" type="number" id="numIntervals" value="5" min="1">
                </div>
                <!-- Adjust Probabilities -->
                <div class="input-item text-center">
                    <div class="step-label">2. Adjust Probabilities (they must sum to 1):</div>
                    <div class="probabilities mt-2">
                        <!-- The probabilities form will be generated here -->
                    </div>
                </div>
                <!-- Number of Samples -->
                <div class="input-item text-center">
                    <div class="step-label">3. Enter Number of Samples:</div>
                    <input class="form-control d-inline-block" type="number" id="attemptsInput" value="1000" min="1">
                </div>
            </div>
            <!-- Invalid Message -->
            <div id="invalidMessage" class="text-center mt-2"></div>
        </div>
        <!-- Start Simulation Button -->
        <div class="text-center mt-3">
            <button class="btn btn-custom" id="startSimulation">Start Simulation</button>
        </div>
        <!-- Combined Histogram and Stats -->
        <div class="graph-and-stats">
            <!-- Graph -->
            <div class="graph-container">
                <canvas id="distributionChart"></canvas>
            </div>
            <!-- Stats -->
            <div class="stats-table-container">
                <div id="stats" class="stats-container">
                    <!-- Mean and variance will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Code -->
    <script>
        window.onload = function() {
            var distributionChart;    // Chart instance
            var counts = [];          // Empirical counts array
            var probs = [];           // Current probabilities
            var theoreticalCounts = [];
            var labels = [];
            var theoreticalMean = 0;
            var theoreticalVariance = 0;
            var mean = 0;  // Welford's
            var m2 = 0;    // Welford's
            var n = 0;     // Welford's
            var statsDiv = document.getElementById('stats');
            var attemptsInput = document.getElementById('attemptsInput');
            var numIntervalsInput = document.getElementById('numIntervals');
            var inputs;
            var maxVisibleProbs = 3; // For container width logic

            // Generate initial probabilities and chart
            generateProbabilities();
            displayStats(0, 0, 0);
            initializeChart();

            // On intervals change:
            numIntervalsInput.oninput = function() {
                generateProbabilities();
                initializeChart();
            };

            // On start simulation button
            document.getElementById("startSimulation").onclick = function() {
                if (!checkSum()) {
                    alert('Please ensure the probabilities sum to 1.');
                    return;
                }
                startSimulation();
            };

            function generateProbabilities() {
                var numIntervals = parseInt(numIntervalsInput.value);
                if (isNaN(numIntervals) || numIntervals <= 0) {
                    alert('Please enter a valid number of intervals.');
                    return;
                }
                var probabilitiesDiv = document.querySelector('.probabilities');
                probabilitiesDiv.innerHTML = '';

                // Try random probabilities that sum exactly to 1
                var validProbsFound = false;
                var trialProbs = [];
                while (!validProbsFound) {
                    trialProbs = [];
                    var total = 0;
                    var i;
                    for (i = 0; i < numIntervals; i++) {
                        var pRand = Math.random();
                        trialProbs.push(pRand);
                        total += pRand;
                    }
                    // Normalize
                    for (i = 0; i < numIntervals; i++) {
                        trialProbs[i] = trialProbs[i] / total;
                        trialProbs[i] = parseFloat(trialProbs[i].toFixed(2));
                    }
                    // Force sum=1 with last correction
                    var sumProbs = 0;
                    for (i = 0; i < trialProbs.length; i++) {
                        sumProbs += trialProbs[i];
                    }
                    sumProbs = parseFloat(sumProbs.toFixed(2));
                    var diff = 1 - sumProbs;
                    trialProbs[numIntervals - 1] += diff;
                    trialProbs[numIntervals - 1] = parseFloat(trialProbs[numIntervals - 1].toFixed(2));

                    // Re-check final sum
                    var finalSum = 0;
                    for (i = 0; i < trialProbs.length; i++) {
                        finalSum += trialProbs[i];
                    }
                    finalSum = parseFloat(finalSum.toFixed(2));
                    if (Math.abs(finalSum - 1) <= 0.0001) {
                        // Check valid range
                        var inRange = true;
                        for (i = 0; i < trialProbs.length; i++) {
                            if (trialProbs[i] < 0 || trialProbs[i] > 1 || isNaN(trialProbs[i])) {
                                inRange = false;
                                break;
                            }
                        }
                        if (inRange) {
                            validProbsFound = true;
                        }
                    }
                }

                probs = trialProbs;

                // Create inputs for probabilities
                var probInputsDiv = document.createElement('div');
                probInputsDiv.classList.add('prob-inputs');

                var i;
                for (i = 0; i < numIntervals; i++) {
                    var div = document.createElement('div');
                    div.classList.add('form-group');
                    var label = document.createElement('label');
                    label.innerHTML = 'p' + (i + 1) + ': ';
                    var input = document.createElement('input');
                    input.type = 'number';
                    input.step = '0.01';
                    input.value = probs[i].toFixed(2);
                    input.min = '0';
                    input.max = '1';
                    input.classList.add('form-control');

                    // On input change, re-check sum
                    input.oninput = function() {
                        if (this.value !== '') {
                            var valF = parseFloat(this.value);
                            if (!isNaN(valF)) {
                                this.value = valF.toFixed(2);
                            }
                        }
                        checkSum();
                    };

                    div.appendChild(label);
                    div.appendChild(input);
                    probInputsDiv.appendChild(div);
                }
                probabilitiesDiv.appendChild(probInputsDiv);
                inputs = probInputsDiv.querySelectorAll('input[type="number"]');

                // Adjust container width
                var totalProbInputsWidth = maxVisibleProbs * 100;
                probabilitiesDiv.style.maxWidth = totalProbInputsWidth + 'px';

                checkSum();
            }

            function checkSum() {
                var invalidMessage = document.getElementById('invalidMessage');
                var total = 0;
                var i;
                var valid = true;
                for (i = 0; i < inputs.length; i++) {
                    var val = parseFloat(inputs[i].value);
                    if (isNaN(val) || val < 0 || val > 1) {
                        valid = false;
                        break;
                    }
                    total += val;
                }
                total = parseFloat(total.toFixed(2));
                if (!valid || Math.abs(total - 1) > 0.01) {
                    invalidMessage.innerHTML = 'Invalid values: probabilities must sum to 1.';
                    return false;
                } else {
                    invalidMessage.innerHTML = '';
                    return true;
                }
            }

            function validateProbabilities(probsArray) {
                var total = 0;
                var i;
                for (i = 0; i < probsArray.length; i++) {
                    total += probsArray[i];
                }
                total = parseFloat(total.toFixed(2));
                if (Math.abs(total - 1) > 0.0001) {
                    return false;
                }
                for (i = 0; i < probsArray.length; i++) {
                    if (probsArray[i] < 0 || probsArray[i] > 1 || isNaN(probsArray[i])) {
                        return false;
                    }
                }
                return true;
            }

            function displayStats(samples, meanVal, varianceVal) {
                statsDiv.innerHTML = '';
                var statsContainer = document.createElement('div');
                statsContainer.classList.add('stats-content');
                statsContainer.style.height = '100%';

                // Samples
                var samplesHeader = document.createElement('div');
                samplesHeader.classList.add('stats-header');
                samplesHeader.innerText = 'Samples: ' + samples;
                statsContainer.appendChild(samplesHeader);

                // Theoretical Mean
                var theoreticalMeanDiv = document.createElement('div');
                theoreticalMeanDiv.classList.add('stats-value');
                theoreticalMeanDiv.innerText = 'Theoretical Mean: ' + theoreticalMean.toFixed(2);
                statsContainer.appendChild(theoreticalMeanDiv);

                // Empirical Mean
                var empiricalMeanDiv = document.createElement('div');
                empiricalMeanDiv.classList.add('stats-value');
                empiricalMeanDiv.innerText = 'Empirical Mean: ' + meanVal.toFixed(2);
                empiricalMeanDiv.id = 'empiricalMeanDiv';
                statsContainer.appendChild(empiricalMeanDiv);

                // Theoretical Variance
                var theoreticalVarianceDiv = document.createElement('div');
                theoreticalVarianceDiv.classList.add('stats-value');
                theoreticalVarianceDiv.innerText = 'Theoretical Variance: ' + theoreticalVariance.toFixed(2);
                statsContainer.appendChild(theoreticalVarianceDiv);

                // Empirical Variance
                var empiricalVarianceDiv = document.createElement('div');
                empiricalVarianceDiv.classList.add('stats-value');
                empiricalVarianceDiv.innerText = 'Empirical Variance: ' + varianceVal.toFixed(2);
                empiricalVarianceDiv.id = 'empiricalVarianceDiv';
                statsContainer.appendChild(empiricalVarianceDiv);

                statsDiv.appendChild(statsContainer);
                adjustStatsContainerHeight();
            }

            function updateEmpiricalStats(samples, meanVal, varianceVal) {
                var samplesHeader = statsDiv.querySelector('.stats-header');
                if (samplesHeader) {
                    samplesHeader.innerText = 'Samples: ' + samples;
                }
                var empMeanDiv = document.getElementById('empiricalMeanDiv');
                if (empMeanDiv) {
                    empMeanDiv.innerText = 'Empirical Mean: ' + meanVal.toFixed(2);
                }
                var empVarDiv = document.getElementById('empiricalVarianceDiv');
                if (empVarDiv) {
                    empVarDiv.innerText = 'Empirical Variance: ' + varianceVal.toFixed(2);
                }
            }

            function initializeChart() {
                var numIntervals = parseInt(numIntervalsInput.value);
                labels = [];
                var i;
                for (i = 0; i < numIntervals; i++) {
                    labels.push('Interval ' + (i + 1));
                }

                counts = new Array(numIntervals);
                theoreticalCounts = new Array(numIntervals);
                for (i = 0; i < numIntervals; i++) {
                    counts[i] = 0;
                    theoreticalCounts[i] = 0;
                }

                if (distributionChart) {
                    distributionChart.destroy();
                }

                var distributionCtx = document.getElementById('distributionChart').getContext('2d');

                var theoreticalDataset = {
                    label: 'Theoretical Counts',
                    data: theoreticalCounts.slice(),
                    backgroundColor: '#095f7a',
                    borderColor: '#074a5e',
                    borderWidth: 1,
                    order: 1
                };
                var empiricalDataset = {
                    label: 'Empirical Counts',
                    data: counts.slice(),
                    backgroundColor: 'rgba(255, 182, 193, 0.6)',
                    borderColor: 'rgba(255, 182, 193, 1)',
                    borderWidth: 1,
                    order: 2
                };

                distributionChart = new Chart(distributionCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [theoreticalDataset, empiricalDataset]
                    },
                    options: {
                        animation: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Frequency' },
                                ticks: {
                                    display: true,
                                    callback: function(value) {
                                        return value;
                                    }
                                },
                                grid: {
                                    display: true
                                }
                            },
                            x: {
                                title: { display: true, text: 'Intervals' },
                                stacked: false
                            }
                        },
                        plugins: {
                            legend: { display: true }
                        },
                        layout: {
                            padding: {
                                top: 20
                            }
                        }
                    }
                });

                adjustStatsContainerHeight();
            }

            function adjustStatsContainerHeight() {
                if (distributionChart) {
                    var chartAreaHeight = distributionChart.chartArea.bottom - distributionChart.chartArea.top;
                    var statsContainer = statsDiv.querySelector('.stats-container');
                    if (statsContainer) {
                        statsContainer.style.height = chartAreaHeight + 'px';
                    }
                }
            }

            function startSimulation() {
                var attempts = parseInt(attemptsInput.value);
                if (isNaN(attempts) || attempts <= 0) {
                    alert('Please enter a valid number of samples.');
                    return;
                }

                probs = [];
                var i;
                for (i = 0; i < inputs.length; i++) {
                    var val = parseFloat(inputs[i].value);
                    probs.push(val);
                }

                theoreticalCounts = [];
                for (i = 0; i < probs.length; i++) {
                    theoreticalCounts.push(probs[i] * attempts);
                }

                labels = [];
                for (i = 0; i < inputs.length; i++) {
                    labels.push('Interval ' + (i + 1));
                }

                counts = [];
                for (i = 0; i < probs.length; i++) {
                    counts.push(0);
                }

                distributionChart.data.labels = labels;
                distributionChart.data.datasets[0].data = theoreticalCounts;
                distributionChart.data.datasets[1].data = counts.slice();

                // Theoretical mean and variance
                theoreticalMean = 0;
                theoreticalVariance = 0;
                for (i = 0; i < probs.length; i++) {
                    var xVal = i + 1;
                    theoreticalMean += xVal * probs[i];
                }
                for (i = 0; i < probs.length; i++) {
                    var xVal2 = i + 1;
                    var diff = xVal2 - theoreticalMean;
                    theoreticalVariance += probs[i] * (diff * diff);
                }

                distributionChart.update();

                // Reset Welford
                for (i = 0; i < probs.length; i++) {
                    counts[i] = 0;
                }
                mean = 0;
                m2 = 0;
                n = 0;

                // Cumulative array
                var cumulativeProbs = [];
                var cumSum = 0;
                for (i = 0; i < probs.length; i++) {
                    cumSum += probs[i];
                    cumulativeProbs.push(cumSum);
                }

                // Display initial stats
                displayStats(n, mean, 0);

                var totalDuration = 5000;
                var intervalTime = 16.67;
                var totalIntervals = Math.ceil(totalDuration / intervalTime);
                var batchSize = Math.ceil(attempts / totalIntervals);

                var interval = setInterval(function() {
                    if (n >= attempts) {
                        clearInterval(interval);
                        return;
                    }
                    var samplesToProcess = batchSize;
                    if (n + batchSize > attempts) {
                        samplesToProcess = attempts - n;
                    }

                    var s;
                    for (s = 0; s < samplesToProcess; s++) {
                        var r = Math.random();
                        var j;
                        for (j = 0; j < cumulativeProbs.length; j++) {
                            if (r <= cumulativeProbs[j]) {
                                counts[j]++;
                                n++;

                                // Welford
                                var xVal3 = j + 1;
                                var delta = xVal3 - mean;
                                mean += delta / n;
                                var delta2 = xVal3 - mean;
                                m2 += delta * delta2;
                                break;
                            }
                        }
                    }

                    var variance = 0;
                    if (n > 1) {
                        variance = m2 / (n - 1);
                    }
                    updateEmpiricalStats(n, mean, variance);

                    distributionChart.data.datasets[1].data = counts.slice();
                    distributionChart.update('none'); 
                }, intervalTime);
            }

            // Adjust stats container after load
            setTimeout(adjustStatsContainerHeight, 500);
        }
    </script>
</body>
</html>

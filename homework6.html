<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Simulatore di Distribuzione di Probabilità</title>
    <!-- Include MathJax for LaTeX rendering -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>
    <!-- Include Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Include Montserrat font -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <!-- Custom CSS for styling -->
    <style>
        html, body {
            margin: 0;
            padding: 0;
            font-family: 'Montserrat', sans-serif;
            font-style: normal;
            font-weight: 400;
            font-size: 19px;
            line-height: 28px;
            color: #1c1c1c;
            background-color: #ffffff; /* White background */
        }
        h1 {
            font-size: 36px;
            color: #095f7a;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
        }
        h2 {
            font-size: 24px;
            color: #095f7a;
            font-weight: bold;
            margin-top: 40px;
            text-align: center;
        }
        p {
            margin-bottom: 20px;
            text-align: center;
        }
        strong {
            font-weight: bold;
        }
        .container {
            text-align: center;
            margin: 0 auto;
            max-width: 1200px;
        }
        .step-label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #495057;
        }
        .form-control {
            max-width: 200px;
            margin: 0 auto;
        }
        .btn-custom {
            background-color: #095f7a;
            color: white !important;
            border: none;
            transition: box-shadow 0.3s ease;
            font-family: 'Montserrat', sans-serif;
            font-weight: bold;
            border-radius: 20px; /* Bottone più arrotondato */
            font-size: 18px; /* Ridotto il font size */
            padding: 12px 25px; /* Ridotto il padding */
            cursor: pointer;
        }
        .btn-custom:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            color: white !important;
        }
        /* Style adjustments for inputs */
        .inputs-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-grow: 1;
            padding: 10px;
        }
        .inputs-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-start;
        }
        .input-item {
            flex: 0 0 auto;
            margin: 10px;
        }
        .inputs-container .form-control {
            max-width: 200px;
            width: 100%;
        }
        /* Adjust probabilities styling */
        .probabilities {
            overflow-x: auto;
            margin: 0 auto;
            max-width: 400px;
        }
        .probabilities .prob-inputs {
            display: inline-block;
            white-space: nowrap;
        }
        .probabilities .form-group {
            display: inline-block;
            vertical-align: middle;
            margin: 5px;
        }
        .probabilities label {
            margin-right: 5px;
        }
        .probabilities input[type="number"] {
            width: 80px;
            display: inline-block;
        }
        #invalidMessage {
            color: red;
            font-weight: bold;
        }
        /* Additional styling for stats section */
        .stats-container {
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-grow: 1;
            height: 100%; /* Assicura che riempia il contenitore genitore */
            justify-content: center; /* Centra verticalmente il contenuto */
        }
        .stats-header {
            font-weight: bold;
            margin-bottom: 10px;
            color: #495057;
        }
        .stats-value {
            font-size: 1em;
            margin: 5px 0;
        }
        /* New styles for graph and stats layout */
        .graph-and-stats {
            display: flex;
            flex-wrap: wrap;
            align-items: stretch;
            margin-top: 50px; /* Aumentato lo spazio sopra il grafico */
        }
        .graph-container {
            flex: 0 0 90%;
            max-width: 90%;
            position: relative;
            display: flex;
            flex-direction: column;
            height: auto;
        }
        .stats-table-container {
            flex: 0 0 10%;
            max-width: 10%;
            display: flex;
            align-items: center;
            justify-content: center;
            height: auto;
        }
        @media (max-width: 1000px) {
            .graph-container, .stats-table-container {
                flex: 0 0 100%;
                max-width: 100%;
            }
            .controls {
                flex-wrap: wrap;
            }
            .btn-custom {
                margin-top: 10px;
            }
        }
        .graph-container canvas {
            width: 98% !important;
            height: 400px !important;
            margin: 0 auto;
            display: block;
            /* border: 2px solid #dee2e6; */ /* Bordo rimosso */
            /* box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); */ /* Ombra rimossa */
            margin-bottom: 30px;
        }
        /* Controls styling */
        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: nowrap;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
        }
        .controls label {
            margin: 0 5px 0 0;
        }
        .controls input {
            width: 100px;
            margin-right: 10px;
        }
        .controls button {
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <!-- Research Content -->
        <h2>Teorema Fondamentale del Calcolo e la Sua Relazione con le Funzioni di Densità e le CDF</h2>
        <p>Il Teorema Fondamentale del Calcolo collega la derivazione e l'integrazione, fornendo un modo per valutare gli integrali definiti. Afferma che se \( f \) è continua nell'intervallo \([a, b]\) e \( F \) è una primitiva di \( f \) su \([a, b]\), allora:</p>
        \[
        \int_a^b f(x) \, dx = F(b) - F(a)
        \]
        <p>In teoria delle probabilità, la funzione di distribuzione cumulativa (CDF) \( F(x) \) di una variabile casuale continua è definita come:</p>
        \[
        F(x) = \int_{-\infty}^x f(t) \, dt
        \]
        <p>dove \( f(t) \) è la funzione di densità di probabilità (PDF). La relazione tra la PDF e la CDF rispecchia il Teorema Fondamentale del Calcolo, poiché la derivata della CDF fornisce la PDF:</p>
        \[
        f(x) = \frac{d}{dx} F(x)
        \]
        <p>Ciò illustra come il Teorema Fondamentale del Calcolo sottenda la connessione tra funzioni di densità e funzioni di distribuzione cumulativa nella teoria delle probabilità.</p>
        <h1>Simulatore di Distribuzione di Probabilità</h1>
        <!-- Instructions -->
        <p>Questo simulatore genera campioni da una distribuzione di probabilità univariata discreta con probabilità arbitrarie. Mostra la convergenza della distribuzione empirica alla distribuzione teorica man mano che la dimensione del campione aumenta. Calcola anche media e varianza utilizzando l'algoritmo di Welford e le confronta con i valori teorici.</p>
        <!-- Inputs Container -->
        <div class="inputs-container mt-4">
            <div class="inputs-row">
                <!-- Number of Intervals -->
                <div class="input-item text-center">
                    <div class="step-label">1. Inserisci il numero di intervalli:</div>
                    <input class="form-control d-inline-block" type="number" id="numIntervals" value="5" min="1">
                </div>
                <!-- Adjust Probabilities -->
                <div class="input-item text-center">
                    <div class="step-label">2. Regola le probabilità (devono sommare a 1):</div>
                    <div class="probabilities mt-2">
                        <!-- The probabilities form will be generated here -->
                    </div>
                </div>
                <!-- Number of Samples -->
                <div class="input-item text-center">
                    <div class="step-label">3. Inserisci il numero di campioni:</div>
                    <input class="form-control d-inline-block" type="number" id="attemptsInput" value="1000" min="1">
                </div>
            </div>
            <!-- Invalid Message -->
            <div id="invalidMessage" class="text-center mt-2"></div>
        </div>
        <!-- Start Simulation Button -->
        <div class="text-center mt-3">
            <button class="btn btn-custom" id="startSimulation">Start Simulation</button>
        </div>
        <!-- Combined Histogram and Stats -->
        <div class="graph-and-stats">
            <!-- Graph -->
            <div class="graph-container">
                <canvas id="distributionChart"></canvas>
            </div>
            <!-- Stats -->
            <div class="stats-table-container">
                <div id="stats" class="stats-container">
                    <!-- Mean and variance will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Include Bootstrap JS dependencies -->
    <!-- (Removed Bootstrap dependencies as they are not used) -->
    <script>
        window.onload = function() {
            var distributionChart; // Chart instance for the combined histogram
            var counts = [];
            var probs = [];
            var theoreticalCounts = [];
            var labels = [];
            var theoreticalMean = 0;
            var theoreticalVariance = 0;
            var mean = 0;
            var m2 = 0;
            var n = 0;
            var statsDiv = document.getElementById('stats');
            var attemptsInput = document.getElementById('attemptsInput');
            var numIntervalsInput = document.getElementById('numIntervals');
            var inputs;
            var maxVisibleProbs = 3; // Reduced number of visible probabilities

            // Event listener for number of intervals change
            numIntervalsInput.oninput = function() {
                generateProbabilities();
                initializeChart(); // Update the chart with new intervals
            };

            // Event listener for start simulation button
            document.getElementById("startSimulation").onclick = function() {
                if (!checkSum()) {
                    alert('Assicurati che le probabilità sommino a 1.');
                    return;
                }
                startSimulation();
            };

            // Initial call to generate probabilities, display stats, and initialize chart
            generateProbabilities();
            displayStats(0, 0, 0);
            initializeChart();

            function generateProbabilities(){
                var numIntervals = parseInt(numIntervalsInput.value);
                if (isNaN(numIntervals) || numIntervals <= 0) {
                    alert('Inserisci un numero valido di intervalli.');
                    return;
                }

                var probabilitiesDiv = document.querySelector('.probabilities');
                probabilitiesDiv.innerHTML = ''; // Clear previous content

                // Generate random probabilities that sum exactly to 1
                do {
                    probs = [];
                    var total = 0;
                    for (var i = 0; i < numIntervals; i++) {
                        var p = Math.random();
                        probs.push(p);
                        total += p;
                    }
                    // Normalize probabilities
                    for (var i = 0; i < numIntervals; i++) {
                        probs[i] = probs[i] / total;
                        probs[i] = parseFloat(probs[i].toFixed(2)); // Limit to 2 decimal places
                    }
                    // Adjust the last probability to ensure the sum is exactly 1
                    var sumProbs = probs.reduce(function(a, b) { return a + b; }, 0);
                    var diff = 1 - sumProbs;
                    probs[numIntervals - 1] += diff;
                    probs[numIntervals - 1] = parseFloat(probs[numIntervals - 1].toFixed(2));

                    // Adjust any rounding errors
                    var finalSum = probs.reduce(function(a, b) { return a + b; }, 0);
                    if (Math.abs(finalSum - 1) > 0.0001) {
                        probs[numIntervals - 1] += 1 - finalSum;
                        probs[numIntervals - 1] = parseFloat(probs[numIntervals - 1].toFixed(2));
                    }
                    // Ensure probabilities are valid and sum to 1
                } while (!validateProbabilities(probs));

                // Create inputs for probabilities
                var probInputsDiv = document.createElement('div');
                probInputsDiv.classList.add('prob-inputs');

                for (var i = 0; i < numIntervals; i++) {
                    var div = document.createElement('div');
                    div.classList.add('form-group');
                    var label = document.createElement('label');
                    label.innerHTML = 'p' + (i+1) + ': ';
                    var input = document.createElement('input');
                    input.type = 'number';
                    input.step = '0.01';
                    input.value = probs[i].toFixed(2);
                    input.min = '0';
                    input.max = '1';
                    input.classList.add('form-control');

                    // Add event listener to check the sum when the value changes
                    input.oninput = function() {
                        // Ensure two decimal places
                        if (this.value !== '') {
                            this.value = parseFloat(this.value).toFixed(2);
                        }
                        checkSum();
                    };

                    div.appendChild(label);
                    div.appendChild(input);
                    probInputsDiv.appendChild(div);
                }
                probabilitiesDiv.appendChild(probInputsDiv);

                inputs = probInputsDiv.querySelectorAll('input[type="number"]');

                // Adjust the width of the probabilities container based on the number of visible inputs
                var totalProbInputsWidth = maxVisibleProbs * 100; // Adjusted width per input
                probabilitiesDiv.style.maxWidth = totalProbInputsWidth + 'px';

                checkSum();
            }

            function validateProbabilities(probsArray) {
                var total = probsArray.reduce(function(a, b) { return a + b; }, 0);
                total = parseFloat(total.toFixed(2));
                if (Math.abs(total - 1) > 0.0001) {
                    return false;
                }
                for (var i = 0; i < probsArray.length; i++) {
                    if (probsArray[i] < 0 || probsArray[i] > 1 || isNaN(probsArray[i])) {
                        return false;
                    }
                }
                return true;
            }

            function checkSum() {
                var invalidMessage = document.getElementById('invalidMessage');
                var total = 0;
                var valid = true;
                for (var i = 0; i < inputs.length; i++) {
                    var val = parseFloat(inputs[i].value);
                    if (isNaN(val) || val < 0 || val > 1) {
                        valid = false;
                        break;
                    }
                    total += val;
                }
                total = parseFloat(total.toFixed(2));
                if (!valid || Math.abs(total - 1) > 0.01) {
                    invalidMessage.innerHTML = 'Valori non validi: le probabilità devono sommare a 1.';
                    return false;
                } else {
                    invalidMessage.innerHTML = '';
                    return true;
                }
            }

            function displayStats(n, mean, variance) {
                // Create stats container
                statsDiv.innerHTML = '';
                var statsContainer = document.createElement('div');
                statsContainer.classList.add('stats-content');
                statsContainer.style.height = '100%'; // Ensure it fills the parent container

                // Samples Header
                var samplesHeader = document.createElement('div');
                samplesHeader.classList.add('stats-header');
                samplesHeader.innerText = 'Campioni: ' + n;
                statsContainer.appendChild(samplesHeader);

                // Theoretical Mean
                var theoreticalMeanDiv = document.createElement('div');
                theoreticalMeanDiv.classList.add('stats-value');
                theoreticalMeanDiv.innerText = 'Media Teorica: ' + theoreticalMean.toFixed(2);
                statsContainer.appendChild(theoreticalMeanDiv);

                // Empirical Mean
                var empiricalMeanDiv = document.createElement('div');
                empiricalMeanDiv.classList.add('stats-value');
                empiricalMeanDiv.innerText = 'Media Empirica: ' + mean.toFixed(2);
                empiricalMeanDiv.id = 'empiricalMeanDiv';
                statsContainer.appendChild(empiricalMeanDiv);

                // Theoretical Variance
                var theoreticalVarianceDiv = document.createElement('div');
                theoreticalVarianceDiv.classList.add('stats-value');
                theoreticalVarianceDiv.innerText = 'Varianza Teorica: ' + theoreticalVariance.toFixed(2);
                statsContainer.appendChild(theoreticalVarianceDiv);

                // Empirical Variance
                var empiricalVarianceDiv = document.createElement('div');
                empiricalVarianceDiv.classList.add('stats-value');
                empiricalVarianceDiv.innerText = 'Varianza Empirica: ' + variance.toFixed(2);
                empiricalVarianceDiv.id = 'empiricalVarianceDiv';
                statsContainer.appendChild(empiricalVarianceDiv);

                statsDiv.appendChild(statsContainer);

                adjustStatsContainerHeight(); // Adjust the height to match chart area
            }

            function updateEmpiricalStats(n, mean, variance) {
                // Update samples header
                var samplesHeader = statsDiv.querySelector('.stats-header');
                samplesHeader.innerText = 'Campioni: ' + n;

                // Update empirical mean and variance
                var empiricalMeanDiv = document.getElementById('empiricalMeanDiv');
                var empiricalVarianceDiv = document.getElementById('empiricalVarianceDiv');

                empiricalMeanDiv.innerText = 'Media Empirica: ' + mean.toFixed(2);
                empiricalVarianceDiv.innerText = 'Varianza Empirica: ' + variance.toFixed(2);
            }

            function initializeChart() {
                var numIntervals = parseInt(numIntervalsInput.value);
                var attempts = parseInt(attemptsInput.value);
                labels = [];
                for (var i = 0; i < numIntervals; i++) {
                    labels.push('Intervallo ' + (i + 1));
                }

                // Initialize counts and theoreticalCounts with zeros
                counts = new Array(numIntervals).fill(0);
                theoreticalCounts = new Array(numIntervals).fill(0);

                // Destroy previous chart if it exists
                if (distributionChart) {
                    distributionChart.destroy();
                }

                // Create the chart with empty datasets
                var distributionCtx = document.getElementById('distributionChart').getContext('2d');

                // Initialize datasets with zeros
                var theoreticalDataset = {
                    label: 'Conteggi Teorici',
                    data: theoreticalCounts.slice(),
                    backgroundColor: '#095f7a',
                    borderColor: '#074a5e',
                    borderWidth: 1,
                    order: 1
                };
                var empiricalDataset = {
                    label: 'Conteggi Empirici',
                    data: counts.slice(),
                    backgroundColor: 'rgba(255, 182, 193, 0.6)', // Pastel Pink
                    borderColor: 'rgba(255, 182, 193, 1)',
                    borderWidth: 1,
                    order: 2
                };

                distributionChart = new Chart(distributionCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [theoreticalDataset, empiricalDataset]
                    },
                    options: {
                        animation: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Frequenza' },
                                ticks: {
                                    display: true,
                                    callback: function(value) {
                                        return value; // Show actual numbers
                                    }
                                },
                                // max: maxYValue, // Rimosso per permettere il ridimensionamento dinamico
                                grid: {
                                    display: true
                                }
                            },
                            x: {
                                title: { display: true, text: 'Intervalli' },
                                stacked: false
                            }
                        },
                        plugins: {
                            legend: { display: true }
                        },
                        layout: {
                            padding: {
                                top: 20 // Adjust to create space above the chart
                            }
                        }
                    }
                });

                adjustStatsContainerHeight(); // Adjust stats container height
            }

            function adjustStatsContainerHeight() {
                // Get the chart area height
                if (distributionChart) {
                    var chartAreaHeight = distributionChart.chartArea.bottom - distributionChart.chartArea.top;
                    var statsContainer = statsDiv.querySelector('.stats-container');

                    if (statsContainer) {
                        // Set the height of the stats container to match the chart area height
                        statsContainer.style.height = chartAreaHeight + 'px';
                    }
                }
            }

            function startSimulation() {
                var attempts = parseInt(attemptsInput.value);
                if (isNaN(attempts) || attempts <= 0) {
                    alert('Inserisci un numero valido di campioni.');
                    return;
                }

                // Get probabilities
                probs = [];
                for (var i = 0; i < inputs.length; i++) {
                    var val = parseFloat(inputs[i].value);
                    probs.push(val);
                }

                // Compute theoretical counts
                theoreticalCounts = probs.map(function(p) { return p * attempts; });

                // Prepare labels
                labels = [];
                for (var i = 0; i < inputs.length; i++) {
                    labels.push('Intervallo ' + (i + 1));
                }

                // Initialize empirical counts to zeros
                counts = new Array(probs.length).fill(0);

                // Update the datasets in the existing chart
                distributionChart.data.labels = labels;
                distributionChart.data.datasets[0].data = theoreticalCounts;
                distributionChart.data.datasets[1].data = counts.slice(); // Start with zeros

                // Compute theoretical mean and variance
                theoreticalMean = 0;
                theoreticalVariance = 0;
                for (var i = 0; i < probs.length; i++) {
                    var x = i + 1; // Assuming x_i = i + 1
                    theoreticalMean += x * probs[i];
                }
                for (var i = 0; i < probs.length; i++) {
                    var x = i + 1;
                    theoreticalVariance += probs[i] * Math.pow(x - theoreticalMean, 2);
                }

                distributionChart.update();

                // Reset counts, mean, m2, n
                counts = new Array(probs.length).fill(0);
                mean = 0;
                m2 = 0;
                n = 0;

                // Prepare cumulative probabilities
                var cumulativeProbs = [];
                var cumulativeSum = 0;
                for (var i = 0; i < probs.length; i++) {
                    cumulativeSum += probs[i];
                    cumulativeProbs.push(cumulativeSum);
                }

                // Display initial stats
                displayStats(n, mean, 0);

                // Variables for simulation timing
                var totalDuration = 5000; // Total simulation duration in milliseconds
                var intervalTime = 16.67; // Frame time in milliseconds (approx. 60 frames per second)
                var totalIntervals = Math.ceil(totalDuration / intervalTime);
                var batchSize = Math.ceil(attempts / totalIntervals);

                var processedSamples = 0;

                var interval = setInterval(function() {
                    if (n >= attempts) {
                        clearInterval(interval);
                        return;
                    }

                    var samplesToProcess = Math.min(batchSize, attempts - n);

                    for (var i = 0; i < samplesToProcess; i++) {
                        // Generate one sample
                        var rand = Math.random();
                        for (var j = 0; j < cumulativeProbs.length; j++) {
                            if (rand <= cumulativeProbs[j]) {
                                counts[j]++;
                                n++;

                                // Welford's algorithm for mean and variance
                                var x = j + 1;
                                var delta = x - mean;
                                mean += delta / n;
                                var delta2 = x - mean;
                                m2 += delta * delta2;

                                break;
                            }
                        }
                    }

                    // Update empirical mean and variance display
                    var variance = n > 1 ? m2 / (n - 1) : 0;
                    updateEmpiricalStats(n, mean, variance);

                    // Update the empirical counts dataset
                    distributionChart.data.datasets[1].data = counts.slice();
                    distributionChart.update('none'); // Disable animation during update

                }, intervalTime);
            }

            // Adjust stats container height after the chart is rendered
            setTimeout(adjustStatsContainerHeight, 500);
        }
    </script>
</body>
</html>
